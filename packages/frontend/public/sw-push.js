// ============================================================================
// Service Worker â€” Push Notification Handlers
// ============================================================================
// This file is imported by the main service worker (generated by vite-plugin-pwa).
// It handles incoming push events and notification click actions.
// ============================================================================

self.addEventListener('push', (event) => {
  const data = event.data?.json() ?? { title: 'NIT SCS', body: 'New notification' };

  event.waitUntil(
    self.registration.showNotification(data.title, {
      body: data.body,
      icon: data.icon || '/pwa-192x192.png',
      badge: '/pwa-192x192.png',
      data: { url: data.url, documentType: data.documentType, documentId: data.documentId },
      tag: data.tag,
      actions: data.actions || [],
    })
  );
});

self.addEventListener('notificationclick', (event) => {
  event.notification.close();

  const { url, documentType, documentId } = event.notification.data || {};

  // Handle action buttons (approve/reject from push notification)
  if (event.action === 'approve' || event.action === 'reject') {
    event.waitUntil(
      fetch('/api/v1/push/action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: event.action, documentType, documentId }),
      }).then(() => {
        if (url) return self.clients.openWindow(url);
      })
    );
    return;
  }

  // Default: navigate to URL or focus existing window
  event.waitUntil(
    self.clients.matchAll({ type: 'window', includeUncontrolled: true }).then((windowClients) => {
      for (const client of windowClients) {
        if (client.url.includes(url || '/') && 'focus' in client) {
          return client.focus();
        }
      }
      return self.clients.openWindow(url || '/');
    })
  );
});
